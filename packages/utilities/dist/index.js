import{Process as e}from"@swindle/os";import{Path as t,FileSystem as o,FileOpenFlag as s,FileSystemException as r}from"@swindle/filesystem";import{rollup as n}from"rollup";import{copy as i}from"fs-extra";import{BaseException as l,StringFormatter as a}from"@swindle/core";import u from"@rollup/plugin-node-resolve";import{babel as p}from"@rollup/plugin-babel";import m from"@rollup/plugin-json";import c from"rollup-plugin-typescript2";import d from"rollup-plugin-styles";import g from"rollup-plugin-polyfill-node";import w from"@rollup/plugin-image";import f from"@rollup/plugin-commonjs";import{Container as S}from"@swindle/container";class y extends l{constructor(e="Something went wrong"){super(e)}}class j extends y{constructor(e="Something went wrong"){super(e)}}const x=new S;x.bind(a,(e=>new a));const D={root:e.Cwd(),outputDir:t.FromSegments(e.Cwd(),"dist"),clientEntryPoint:t.FromSegments(e.Cwd(),"src/client.ts"),serverEntryPoint:t.FromSegments(e.Cwd(),"src/server.ts"),assetsDir:t.FromSegments(e.Cwd(),"src/assets/**/**"),onBeforeRollup:async()=>{},onRollup:async()=>{},onBeforeGenerate:async()=>{},onGenerate:async()=>{}},v={compilerOptions:{strict:!0,target:"ESNext",module:"ESNext",moduleResolution:"node",allowSyntheticDefaultImports:!0,esModuleInterop:!0,jsx:"preserve",jsxImportSource:"solid-js"}},b=async(e,t)=>{t.output&&(Array.isArray(t.output)?await Promise.all(t.output.map((async t=>await e.write(t)))):await e.write(t.output))},C=async(r={})=>{const l=(e=>({root:e.root||D.root,outputDir:e.outputDir||D.outputDir,clientEntryPoint:e.clientEntryPoint||D.clientEntryPoint,serverEntryPoint:e.serverEntryPoint||D.serverEntryPoint,assetsDir:e.assetsDir||D.assetsDir,onBeforeRollup:e.onBeforeRollup||D.onBeforeRollup,onRollup:e.onRollup||D.onRollup,onBeforeGenerate:e.onBeforeGenerate||D.onBeforeGenerate,onGenerate:e.onGenerate||D.onGenerate}))(r),S=(await(async(r=e.Cwd())=>{const n=t.FromSegments(r,"tsconfig.json");let i=v;if(await o.Contains(n)){const e=await o.Open(n,s.READ),t=await e.readAll();await e.close(),i=JSON.parse(t)}return i})(l.root),await(async(r=e.Cwd())=>{const n=t.FromSegments(r,"package.json");let i={deps:[],dev:[]};if(!await o.Contains(n))throw new y("Cannot find package.json file.");{const e=await o.Open(n,s.READ),t=await e.readAll();await e.close();const r=JSON.parse(t);i.deps=Object.keys(r.dependencies),i.dev=Object.keys(r.devDependencies)}return i})()),C=((e,o,s,r,n,i,l,S)=>{const y=[...o,...s,"@solidusjs/core","@solidusjs/client","@solidusjs/server","@solidusjs/utilities"],j=x.get(a),D={};o.forEach((e=>{D[e]=j.camelCase(e)})),D["@solidusjs/core"]=j.camelCase("@solidusjs/core"),D["@solidusjs/client"]=j.camelCase("@solidusjs/client"),D["@solidusjs/server"]=j.camelCase("@solidusjs/server"),D["@solidusjs/utilities"]=j.camelCase("@solidusjs/utilities");const v={declaration:!0,declarationDir:t.FromSegments(n,"types").toString()},b={tsconfig:t.FromSegments(r,"tsconfig.json").toString(),check:!0,clean:!0,abortOnError:!0,rollupCommonJSResolveHack:!1,useTsconfigDeclarationDir:!0,cwd:r.toString(),tsconfigOverride:v},C={input:i.toString(),output:[{file:t.FromSegments(n,"index.js").toString(),format:"esm",globals:D}],external:y,plugins:[g(),u({preferBuiltins:!0,exportConditions:["solid"],extensions:[".js",".jsx",".ts",".tsx"],mainFields:["main","module","browser","exports"],rootDir:r.toString(),moduleDirectories:[t.FromSegments(r,"src").toString()]}),c(b),f(),p({babelHelpers:"bundled",presets:[["solid",{generate:"ssr",hydratable:!0}]],exclude:"node_modules/**",extensions:[".js",".jsx",".ts",".tsx"]}),m(),d(),w()],preserveEntrySignatures:!1,treeshake:!0};return[{input:l.toString(),output:[{file:t.FromSegments(n,"public/scripts/client.js").toString(),format:"esm",globals:D}],plugins:[g(),u({preferBuiltins:!0,exportConditions:["solid"],extensions:[".js",".jsx",".ts",".tsx"],moduleDirectories:[t.FromSegments(r,"src").toString()],rootDir:r.toString(),browser:!0}),c(b),f({include:t.FromSegments(r,"node_modules/**").toString()}),p({babelHelpers:"bundled",presets:[["solid",{generate:"dom",hydratable:!0}]],exclude:"node_modules/**",extensions:[".js",".jsx",".ts",".tsx"]}),m(),d(),w()],preserveEntrySignatures:!1,treeshake:!0},C]})(0,S.deps,S.dev,l.root,l.outputDir,l.serverEntryPoint,l.clientEntryPoint,l.assetsDir);try{await l.onBeforeRollup();const e=await Promise.all(C.map((async e=>await n(e))));await l.onRollup(),await o.Contains(l.outputDir)&&await o.Delete(l.outputDir,!0,!0),await l.onBeforeGenerate();const s=e.length;for(let t=0;t<s;t++)await b(e[t],C[t]);await i(l.assetsDir.toString(),t.FromSegments(l.root.toString(),"dist/public").toString(),{overwrite:!0,preserveTimestamps:!0}),await l.onGenerate()}catch(e){let t;throw t=e,new j(t.message)}};export{j as SolidusBuildException,y as SolidusException,C as buildApp};
