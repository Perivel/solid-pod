import{Process as e}from"@swindle/os";import{Path as t,FileSystem as o,FileOpenFlag as r,FileSystemException as s}from"@swindle/filesystem";import{rollup as n}from"rollup";import{copy as i}from"fs-extra";import{BaseException as l,StringFormatter as a}from"@swindle/core";import p from"@rollup/plugin-node-resolve";import{babel as u}from"@rollup/plugin-babel";import m from"@rollup/plugin-json";import c from"rollup-plugin-typescript2";import d from"rollup-plugin-styles";import g from"rollup-plugin-polyfill-node";import w from"@rollup/plugin-image";import f from"@rollup/plugin-commonjs";import{Container as y}from"@swindle/container";class S extends l{constructor(e="Something went wrong"){super(e)}}class x extends S{constructor(e="Something went wrong"){super(e)}}const j=new y;j.bind(a,(e=>new a));const D={root:e.Cwd(),outputDir:t.FromSegments(e.Cwd(),"dist"),clientEntryPoint:t.FromSegments(e.Cwd(),"src/client.ts"),serverEntryPoint:t.FromSegments(e.Cwd(),"src/server.ts"),assetsDir:t.FromSegments(e.Cwd(),"src/assets/**/**"),onBeforeRollup:async()=>{},onRollup:async()=>{},onBeforeGenerate:async()=>{},onGenerate:async()=>{}},b={compilerOptions:{strict:!0,target:"ESNext",module:"ESNext",moduleResolution:"node",allowSyntheticDefaultImports:!0,esModuleInterop:!0,jsx:"preserve",jsxImportSource:"solid-js"}},v=(e,o,r,s,n,i,l,y)=>{const S=[...o,...r,"@solidusjs/core","@solidusjs/client","@solidusjs/server","@solidusjs/utilities"],x=j.get(a),D={};o.forEach((e=>{Object.defineProperty(D,e,{value:x.camelCase(e)})}));const b={declaration:!0,declarationDir:t.FromSegments(n,"types").toString()},v={tsconfig:t.FromSegments(s,"tsconfig.json").toString(),check:!0,clean:!0,abortOnError:!0,rollupCommonJSResolveHack:!1,useTsconfigDeclarationDir:!0,cwd:s.toString(),tsconfigOverride:b},E={input:i.toString(),output:[{file:t.FromSegments(n,"index.js").toString(),format:"esm",globals:D}],external:S,plugins:[g(),p({preferBuiltins:!0,exportConditions:["solid"],extensions:[".js",".jsx",".ts",".tsx"],mainFields:["main","module","browser","exports"]}),c(v),f(),u({babelHelpers:"bundled",presets:[["solid",{generate:"ssr",hydratable:!0}]],exclude:"node_modules/**",extensions:[".js",".jsx",".ts",".tsx"]}),m(),d(),w()],preserveEntrySignatures:!1,treeshake:!0};return[{input:l.toString(),output:[{file:t.FromSegments(n,"public/scripts/client.js").toString(),format:"esm",globals:D}],external:S,plugins:[c(v),p({preferBuiltins:!0,exportConditions:["solid"],extensions:[".js",".jsx",".ts",".tsx"]}),g(),f({include:"node_modules/**"}),u({babelHelpers:"bundled",presets:[["solid",{generate:"dom",hydratable:!0}]],exclude:"node_modules/**",extensions:[".js",".jsx",".ts",".tsx"]}),m(),d(),w()],preserveEntrySignatures:!1,treeshake:!0},E]},E=async(e,t)=>{t.output&&(Array.isArray(t.output)?await Promise.all(t.output.map((async t=>await e.write(t)))):await e.write(t.output))},C=async(s={})=>{const l=(e=>({root:e.root||D.root,outputDir:e.outputDir||D.outputDir,clientEntryPoint:e.clientEntryPoint||D.clientEntryPoint,serverEntryPoint:e.serverEntryPoint||D.serverEntryPoint,assetsDir:e.assetsDir||D.assetsDir,onBeforeRollup:e.onBeforeRollup||D.onBeforeRollup,onRollup:e.onRollup||D.onRollup,onBeforeGenerate:e.onBeforeGenerate||D.onBeforeGenerate,onGenerate:e.onGenerate||D.onGenerate}))(s),a=(await(async(s=e.Cwd())=>{const n=t.FromSegments(s,"tsconfig.json");let i=b;if(await o.Contains(n)){const e=await o.Open(n,r.READ),t=await e.readAll();await e.close(),i=JSON.parse(t)}return i})(l.root),await(async(s=e.Cwd())=>{const n=t.FromSegments(s,"package.json");let i={deps:[],dev:[]};if(!await o.Contains(n))throw new S("Cannot find package.json file.");{const e=await o.Open(n,r.READ),t=await e.readAll();await e.close();const s=JSON.parse(t);i.deps=Object.keys(s.dependencies),i.dev=Object.keys(s.devDependencies)}return i})()),p=v(0,a.deps,a.dev,l.root,l.outputDir,l.serverEntryPoint,l.clientEntryPoint,l.assetsDir);try{await l.onBeforeRollup();const e=await Promise.all(p.map((async e=>await n(e))));await l.onRollup(),await o.Contains(l.outputDir)&&await o.Delete(l.outputDir,!0,!0),await l.onBeforeGenerate();const r=e.length;for(let t=0;t<r;t++)await E(e[t],p[t]);await i(l.assetsDir.toString(),t.FromSegments(l.root.toString(),"dist/public").toString(),{overwrite:!0,preserveTimestamps:!0}),await l.onGenerate()}catch(e){let t;throw t=e,new x(t.message)}};export{x as SolidusBuildException,S as SolidusException,C as buildApp,v as loadBuildConfigurationOptions};
